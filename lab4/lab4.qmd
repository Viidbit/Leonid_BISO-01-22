---
title: "Исследование метаданных DNS трафика"
subtitle: "Практика №4"
author: "Lona610@yandex.ru"
format: 
  md:
    output-file: README.md
---



## Цель работы

1.  Зекрепить практические навыки использования языка программирования R
    для обработки данных
2.  Закрепить знания основных функций обработки данных экосистемы
    tidyverse языка R
3.  Закрепить навыки исследования метаданных DNS трафика

## Исходные данные

1.  Программное обеспечение ОС Windows 11
2.  VS Code
3.  Интерпретатор языка R 4.5.1

## Задания

1.  Импортируйте данные DNS –
    https://storage.yandexcloud.net/dataset.ctfsec/dns.zip Данные были
    собраны с помощью сетевого анализатора zeek
2.  Добавьте пропущенные данные о структуре данных (назначении столбцов)
3.  Преобразуйте данные в столбцах в нужный формат,просмотрите общую
    структуру данных с помощью функции glimpse()
4.  Сколько участников информационного обмена всети Доброй Организации?
5.  Какое соотношение участников обмена внутрисети и участников
    обращений к внешним ресурсам?
6.  Найдите топ-10 участников сети, проявляющих наибольшую сетевую
    активность.
7.  Найдите топ-10 доменов, к которым обращаются пользователи сети и
    соответственное количество обращений
8.  Опеределите базовые статистические характеристики (функция summary()
    ) интервала времени между последовательными обращениями к топ-10
    доменам.
9.  Часто вредоносное программное обеспечение использует DNS канал в
    качестве канала управления, периодически отправляя запросы на
    подконтрольный злоумышленникам DNS сервер. По периодическим запросам
    на один и тот же домен можно выявить скрытый DNS канал. Есть ли
    такие IP адреса в исследуемом датасете?
10. Определите местоположение (страну, город) и организацию-провайдера
    для топ-10 доменов. Для этого можно использовать сторонние
    сервисы,например http://ip-api.com (API-эндпоинт –
    http://ip-api.com/json).

## Шаги:

1 Импортируйте данные DNS

``` {r}
library(tidyverse)
library(lubridate)
library(jsonlite)
```



``` {r}

url <- "https://storage.yandexcloud.net/dataset.ctfsec/dns.zip"
download.file(url, "dns.zip")
unzip("dns.zip")
dns <- read_tsv("dns.log", comment = "#", col_names = FALSE)
```

 
2 Добавьте пропущенные данные о структуре данных (назначении столбцов) 



``` {r}
colnames(dns) <- c(
  "ts", "uid", "id.orig_h", "id.orig_p", "id.resp_h", "id.resp_p",
  "proto", "trans_id", "rtt", "query", "qclass", "qclass_name",
  "qtype", "qtype_name", "rcode", "rcode_name", "AA", "TC",
  "RD", "RA", "Z", "answers", "TTLs", "rejected"
)
```

3 Преобразуйте данные в столбцах в нужный формат

``` {r}
dns <- dns %>%
  mutate(
    ts = as_datetime(ts),
    id.orig_p = as.integer(id.orig_p),
    id.resp_p = as.integer(id.resp_p),
    rtt = as.numeric(rtt)
  )
```

4 Просмотрите общую структуру данных с помощью функции glimpse()

``` {r}
glimpse(dns)
```


5 Сколько участников информационного обмена в сети Доброй Организации?

``` {r}
participants <- unique(c(dns$id.orig_h, dns$id.resp_h))
cat("Участников обмена:", length(participants), "\n")
```




6 Какое соотношение участников обмена внутри сети и участников обращений
к внешним ресурсам?

``` {r}
internal_ips <- dns %>% filter(str_detect(id.orig_h, "^192\\.168|^10\\.|^172\\.(1[6-9]|2[0-9]|3[0-1])"))
external_ips <- dns %>% filter(!str_detect(id.orig_h, "^192\\.168|^10\\.|^172\\.(1[6-9]|2[0-9]|3[0-1])"))

cat("Внутренние участники:", nrow(internal_ips), "\n")
cat("Внешние участники:", nrow(external_ips), "\n")
```

7 Найдите топ-10 участников сети, проявляющих наибольшую сетевую
активность.

``` {r}
top_active <- dns %>%
  count(id.orig_h, sort = TRUE) %>%
  head(10)
print("Топ-10 активных участников:")
print(top_active)
```



8 Найдите топ-10 доменов, к которым обращаются пользователи сети и
соответственное количество обращений

``` {r}
top_domains <- dns %>%
  count(query, sort = TRUE) %>%
  head(10)
print("Топ-10 доменов:")
print(top_domains)
```


    Топ доменов:

``` {r}
print(top_domains)
```





9 Опеределите базовые статистические характеристики (функция summary())
интервала времени между последовательными обращениями к топ-10 доменам

``` {r}
top_domains_list <- top_domains$query
dns_top <- dns %>% filter(query %in% top_domains_list) %>% arrange(ts)

time_diffs <- dns_top %>%
  group_by(query) %>%
  mutate(diff = as.numeric(ts - lag(ts), units = "secs")) %>%
  summarise(
    min = min(diff, na.rm = TRUE),
    q1 = quantile(diff, 0.25, na.rm = TRUE),
    median = median(diff, na.rm = TRUE),
    mean = mean(diff, na.rm = TRUE),
    q3 = quantile(diff, 0.75, na.rm = TRUE),
    max = max(diff, na.rm = TRUE)
  )
print("Статистика интервалов запросов:")
print(time_diffs)
```


10 Часто вредоносное программное обеспечение использует DNS канал в
качестве канала управления, периодически отправляя запросы на
подконтрольный злоумышленникам DNS сервер. По периодическим запросам на
один и тот же домен можно выявить скрытый DNS канал. Есть ли такие IP
адреса в исследуемом датасете?

``` {r}
periodic_ips <- dns %>%
  filter(query %in% top_domains_list) %>%
  group_by(id.orig_h, query) %>%
  summarise(
    request_count = n(),
    time_span = as.numeric(max(ts) - min(ts), units = "secs"),
    avg_interval = time_span / (request_count - 1)
  ) %>%
  filter(request_count > 5, avg_interval < 3600) %>%  # более 5 запросов, средний интервал < 1 часа
  arrange(avg_interval)

print("Подозрительные IP с периодическими запросами:")
print(periodic_ips)

```

11 Определите местоположение (страну, город) и организацию-провайдера 
для топ-10 доменов. Для этого можно использовать сторонние сервисы,
например http://ip-api.com (API-эндпоинт – http://ip-api.com/json).

``` {r}
get_ip_info <- function(ip) {
  url <- paste0("http://ip-api.com/json/", ip)
  response <- fromJSON(url)
  if (response$status == "success") {
    return(tibble(
      ip = ip,
      country = response$country,
      city = response$city,
      isp = response$isp
    ))
  } else {
    return(tibble(ip = ip, country = NA, city = NA, isp = NA))
  }
}

```

## Оценка результата

В результате практической работы мы поняли как анализировать данные DNS
с помощью языка R.

## Вывод

Таким образом, мы научились, используя язык r, скачивать и анализировать
данные DNS.

